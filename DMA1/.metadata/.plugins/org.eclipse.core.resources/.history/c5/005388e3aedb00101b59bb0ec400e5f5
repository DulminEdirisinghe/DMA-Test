#include <stdio.h>
#include "xil_io.h"
#include "xparameters.h"
#include "xbram.h"
#include "xil_cache.h"
#include "sdCard.h"

#define inputImageWidth  28
#define inputImageHeight 28
#define IMG_BYTES (inputImageWidth*inputImageHeight)


#define BRAM_BASE XPAR_AXI_BRAM_CTRL_0_S_AXI_BASEADDR

static char inputImage[IMG_BYTES];

void print_28x28_u8_from_bram(u32 base)
{
    for (int r = 0; r < 28; r++) {
        for (int c = 0; c < 28; c++) {
            unsigned v = (unsigned)Xil_In8(base + (r*28 + c));
            xil_printf("%3d ", v);
        }
        xil_printf("\r\n");
    }
}
void ddr_to_bram_xbram(const u8 *inputImage)
{
    int i;

    // Write 4 bytes at a time (32-bit BRAM)
    for (i = 0; i + 3 < IMG_BYTES; i += 4) {

        u32 w =  ((u32)inputImage[i + 0])       |
                ((u32)inputImage[i + 1] << 8)  |
                ((u32)inputImage[i + 2] << 16) |
                ((u32)inputImage[i + 3] << 24);

        // RegOffset is in BYTES for AXI memory map
        XBram_WriteReg(BRAM_BASE, i, w);
    }

    // If IMG_BYTES not multiple of 4, handle remaining bytes
    for (; i < IMG_BYTES; i++) {
        // read-modify-write the containing word
        u32 word_off = (i & ~3);                 // aligned offset
        u32 shift    = (i & 3) * 8;

        u32 oldw = XBram_ReadReg(BRAM_BASE, word_off);
        u32 neww = (oldw & ~(0xFFu << shift)) | ((u32)inputImage[i] << shift);

        XBram_WriteReg(BRAM_BASE, word_off, neww);
    }
}

int main()
{

    int status;

    XBram Bram;
    XBram_Config *ConfigPtr;
    ConfigPtr = XBram_LookupConfig(XPAR_BRAM_0_DEVICE_ID);
    if(ConfigPtr ==(XBram_Config*)NULL)
    {
    	return XST_FAILURE;

    }
    status = XBram_CfgInitialize(&Bram, ConfigPtr, ConfigPtr->CtrlBaseAddress);
    if (status != XST_SUCCESS) {
           print("BRAM init failed\n\r");
           return XST_FAILURE;
    }


    status = SD_Init();
    if (status != XST_SUCCESS) {
        print("file system init failed\n\r");
        return XST_FAILURE;
    }
    xil_printf("Input image Buffer address %0x\n\r",inputImage);
    // Read image from SD into DDR buffer
    status = ReadFile("image1.bin", (u32)inputImage);
    if (status != XST_SUCCESS) {
        print("file read failed\n\r");
        //return XST_FAILURE;
    }

    print_28x28_u8_from_bram(inputImage);

    //for (int i = 0; i < IMG_BYTES; i++) {
    //    Xil_Out8(BRAM_BASE + i, (u8)inputImage[i]);
    //}

    ddr_to_bram_xbram((const u8*)inputImage);
    print_28x28_u8_from_bram(BRAM_BASE);




    print("DDR -> BRAM Initialized!\n\r");



    // SD eject
    status = SD_Eject();
    if (status != XST_SUCCESS) {
        print("SD card unmount failed\n\r");
        return XST_FAILURE;
    }

    print("done...\r\n");
    return 0;
}
